<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM Maps - Property Manager v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 flex items-center gap-3">
                        üó∫Ô∏è ADM Maps - Property Manager v5
                    </h1>
                    <p class="text-gray-600 mt-2">Visualize propriedades antigas e compare com novas</p>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üìç Mapa de Propriedades</h2>
                <div class="flex gap-3">
                    <button id="importKMLBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        üì¶ Importar KML Antigo
                    </button>
                    <button id="deleteOldBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-700 transition-colors">
                        üóëÔ∏è Deletar Propriedades Antigas
                    </button>
                    <button id="deleteNewBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        üóëÔ∏è Deletar Novas Propriedades
                    </button>
                </div>
            </div>
            <div id="map" class="w-full h-96 rounded-lg shadow-lg"></div>
            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-600 rounded-full"></div>
                    <span class="text-gray-700">Available Lands (<span id="availableCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
                    <span class="text-gray-700">Partners Available (<span id="partnersCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-red-600 rounded-full"></div>
                    <span class="text-gray-700">Sold Lands (<span id="soldCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white"></div>
                    <span class="text-gray-700">Blocked/Paused (<span id="blockedCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-400 rounded-full"></div>
                    <span class="text-gray-700">Novas Propriedades (<span id="newCount">0</span>)</span>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üì§ Importar Novas Propriedades (CSV)</h2>
            <div id="dropZone" class="border-4 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-500 transition-colors cursor-pointer">
                <input type="file" id="fileInput" accept=".csv" multiple class="hidden">
                <p class="text-gray-600 text-lg mb-2">Arraste e solte ou clique para selecionar</p>
                <p class="text-gray-400 text-sm">Arquivo CSV exportado do Parcel Fair</p>
            </div>
            <div id="fileList" class="mt-4"></div>
        </div>

        <!-- Downloads Section -->
        <div id="downloadsSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚¨áÔ∏è Downloads por Condado</h2>
            <div id="downloadButtons" class="flex flex-wrap gap-3"></div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                <h3 class="text-sm font-semibold opacity-90 mb-2">Total de Propriedades</h3>
                <p id="totalProperties" class="text-4xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
                <h3 class="text-sm font-semibold opacity-90 mb-2">Condados</h3>
                <p id="totalCounties" class="text-4xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
                <h3 class="text-sm font-semibold opacity-90 mb-2">Arquivos Carregados</h3>
                <p id="totalFiles" class="text-4xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-lg p-6 text-white">
                <h3 class="text-sm font-semibold opacity-90 mb-2">Novas no Mapa</h3>
                <p id="newOnMap" class="text-4xl font-bold">0</p>
            </div>
        </div>

        <!-- Data Table -->
        <div id="tableSection" class="hidden bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Dados Completos (Novas Propriedades)</h2>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parcel ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">City</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">County</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acres</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Due</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Hidden file input for KML import -->
        <input type="file" id="kmlFileInput" accept=".kml" multiple class="hidden">
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([27.32, -81.37], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Layer groups
        const existingPropertiesLayer = L.layerGroup().addTo(map);
        const newPropertiesLayer = L.layerGroup().addTo(map);

        // Data storage
        let allNewProperties = [];
        let loadedFiles = [];
        let countyData = {};

        // Counters
        let propertyCounts = {
            available: 0,
            partners: 0,
            sold: 0,
            blocked: 0,
            new: 0
        };

        // Custom marker icons with SVG
        const createIcon = (svgContent) => L.divIcon({
            html: svgContent,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const icons = {
            available: createIcon(`<svg width="30" height="45" viewBox="0 0 30 45"><path fill="#16a34a" d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z"/><circle cx="15" cy="13" r="4" fill="#FFF"/></svg>`),
            
            partners: createIcon(`<svg width="30" height="45" viewBox="0 0 30 45"><path fill="#4b5563" d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z"/><circle cx="15" cy="13" r="4" fill="#FFF"/></svg>`),
            
            sold: createIcon(`<svg width="30" height="45" viewBox="0 0 30 45"><path fill="#dc2626" d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z"/><path d="M11 18 L15 10 L19 18 L19 22 L11 22 Z" fill="white"/><rect x="13.5" y="18" width="3" height="4" fill="#dc2626"/><line x1="12" y1="12" x2="18" y2="20" stroke="white" stroke-width="1.5"/><line x1="18" y1="12" x2="12" y2="20" stroke="white" stroke-width="1.5"/></svg>`),
            
            blocked: createIcon(`<svg width="30" height="45" viewBox="0 0 30 45"><path fill="#dc2626" d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z"/><circle cx="15" cy="13" r="5" fill="none" stroke="white" stroke-width="1.5"/><line x1="11" y1="9" x2="19" y2="17" stroke="white" stroke-width="1.5"/></svg>`),
            
            new: createIcon(`<svg width="30" height="45" viewBox="0 0 30 45"><path fill="#facc15" d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z"/><circle cx="15" cy="13" r="4" fill="#FFF"/></svg>`)
        };

        // Load KML files automatically (excluding Outros)
        const kmlFiles = [
            { file: 'AvailableLands.kml', type: 'available', name: 'Available Lands' },
            { file: 'PartnersAvailableLands.kml', type: 'partners', name: 'Partners Available' },
            { file: 'SoldLands.kml', type: 'sold', name: 'Sold Lands' },
            { file: 'BlockedPaused.kml', type: 'blocked', name: 'Blocked/Paused' }
        ];

        let kmlLoadedCount = 0;

        function parseKML(kmlText, type, name) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            
            for (let placemark of placemarks) {
                const nameEl = placemark.getElementsByTagName('name')[0];
                const coordsEl = placemark.getElementsByTagName('coordinates')[0];
                
                if (nameEl && coordsEl) {
                    const coords = coordsEl.textContent.trim().split(',');
                    const lng = parseFloat(coords[0]);
                    const lat = parseFloat(coords[1]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng], { icon: icons[type] })
                            .bindPopup(`<strong>${nameEl.textContent}</strong><br>${name}`)
                            .addTo(existingPropertiesLayer);
                        
                        propertyCounts[type]++;
                    }
                }
            }
            
            document.getElementById(`${type}Count`).textContent = propertyCounts[type];
        }

        // Load all KML files
        if (kmlFiles.length > 0) {
            kmlFiles.forEach(({ file, type, name }) => {
                fetch(file)
                    .then(response => response.text())
                    .then(kmlText => {
                        parseKML(kmlText, type, name);
                        kmlLoadedCount++;
                        
                        if (kmlLoadedCount === kmlFiles.length) {
                            // Fit map to show all existing properties
                            const layers = existingPropertiesLayer.getLayers();
                            if (layers.length > 0) {
                                const bounds = L.latLngBounds([]);
                                layers.forEach(layer => bounds.extend(layer.getLatLng()));
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    })
                    .catch(err => {
                        console.error(`Error loading ${file}:`, err);
                        kmlLoadedCount++;
                        
                        if (kmlLoadedCount === kmlFiles.length) {
                            // Fit map to show all existing properties
                            const layers = existingPropertiesLayer.getLayers();
                            if (layers.length > 0) {
                                const bounds = L.latLngBounds([]);
                                layers.forEach(layer => bounds.extend(layer.getLatLng()));
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    });
            });
        }

        // File upload handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            for (let file of files) {
                if (file.name.endsWith('.csv')) {
                    loadedFiles.push(file);
                    processCSV(file);
                }
            }
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = loadedFiles.map((file, index) => `
                <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3 mb-2">
                    <span class="text-green-700">‚úì ${file.name}</span>
                    <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">‚úï</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            loadedFiles.splice(index, 1);
            updateFileList();
            reprocessAllFiles();
        }

        function reprocessAllFiles() {
            allNewProperties = [];
            countyData = {};
            newPropertiesLayer.clearLayers();
            
            loadedFiles.forEach(file => processCSV(file));
        }

        function processCSV(file) {
            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    const data = results.data.filter(row => row.Coordinates);
                    
                    data.forEach(row => {
                        const coords = row.Coordinates.split(',');
                        const lat = parseFloat(coords[0]);
                        const lng = parseFloat(coords[1]);
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            // Add to map with yellow marker
                            const marker = L.marker([lat, lng], { icon: icons.new })
                                .bindPopup(`
                                    <strong>${row.Name}</strong><br>
                                    ${row.Address}<br>
                                    ${row.City}, ${row.State} ${row.Zip}<br>
                                    <strong>Parcel ID:</strong> ${row['Parcel Number']}<br>
                                    <strong>Acres:</strong> ${row.Acres}<br>
                                    <strong>Amount Due:</strong> $${row['Amount Due']}
                                `)
                                .addTo(newPropertiesLayer);
                            
                            // Store marker reference with property data
                            row.marker = marker;
                            allNewProperties.push(row);
                            
                            // Group by county
                            const county = row.County;
                            if (!countyData[county]) {
                                countyData[county] = [];
                            }
                            countyData[county].push(row);
                        }
                    });
                    
                    propertyCounts.new = allNewProperties.length;
                    updateUI();
                }
            });
        }

        function updateUI() {
            // Update counters
            document.getElementById('newCount').textContent = propertyCounts.new;
            document.getElementById('totalProperties').textContent = propertyCounts.new;
            document.getElementById('totalCounties').textContent = Object.keys(countyData).length;
            document.getElementById('totalFiles').textContent = loadedFiles.length;
            document.getElementById('newOnMap').textContent = propertyCounts.new;
            
            // Show/hide sections
            if (allNewProperties.length > 0) {
                document.getElementById('deleteNewBtn').classList.remove('hidden');
                document.getElementById('downloadsSection').classList.remove('hidden');
                document.getElementById('tableSection').classList.remove('hidden');
                
                // Generate download buttons
                generateDownloadButtons();
                
                // Populate table
                populateTable();
                
                // Fit map to show all markers
                const allLayers = [...existingPropertiesLayer.getLayers(), ...newPropertiesLayer.getLayers()];
                if (allLayers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    allLayers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }

        function generateDownloadButtons() {
            const container = document.getElementById('downloadButtons');
            container.innerHTML = '';
            
            Object.keys(countyData).forEach(county => {
                const properties = countyData[county];
                const firstProp = properties[0];
                const date = new Date(firstProp['Next Auction']);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const dateStr = `${day}${month}`;
                
                const button = document.createElement('button');
                button.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors';
                button.innerHTML = `‚¨áÔ∏è ${county} - ${properties.length} propriedades`;
                button.onclick = () => downloadCountyCSV(county, dateStr, properties);
                container.appendChild(button);
            });
        }

        function downloadCountyCSV(county, dateStr, properties) {
            const csv = Papa.unparse(properties);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${county}_${dateStr}_coordinates.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function populateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = allNewProperties.map((row, index) => `
                <tr class="hover:bg-blue-50 cursor-pointer transition-colors" data-index="${index}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.Name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row['Parcel Number']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.Address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.City}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.County}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.Acres}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${row['Amount Due']}</td>
                </tr>
            `).join('');
            
            // Add click event to table rows
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.addEventListener('click', () => {
                    const index = parseInt(row.getAttribute('data-index'));
                    const property = allNewProperties[index];
                    
                    if (property && property.marker) {
                        // Zoom to marker
                        map.setView(property.marker.getLatLng(), 16);
                        // Open popup
                        property.marker.openPopup();
                        // Scroll to top to see the map
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            });
        }

        // Delete old properties
        document.getElementById('deleteOldBtn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja deletar todas as propriedades antigas (KML)?')) {
                existingPropertiesLayer.clearLayers();
                propertyCounts.available = 0;
                propertyCounts.partners = 0;
                propertyCounts.sold = 0;
                propertyCounts.blocked = 0;
                
                document.getElementById('availableCount').textContent = 0;
                document.getElementById('partnersCount').textContent = 0;
                document.getElementById('soldCount').textContent = 0;
                document.getElementById('blockedCount').textContent = 0;
                
                // Fit map to new properties if they exist
                const newLayers = newPropertiesLayer.getLayers();
                if (newLayers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    newLayers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    map.setView([27.32, -81.37], 10);
                }
            }
        });

        // Delete new properties
        document.getElementById('deleteNewBtn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja deletar todas as novas propriedades?')) {
                allNewProperties = [];
                countyData = {};
                loadedFiles = [];
                newPropertiesLayer.clearLayers();
                propertyCounts.new = 0;
                
                document.getElementById('deleteNewBtn').classList.add('hidden');
                document.getElementById('downloadsSection').classList.add('hidden');
                document.getElementById('tableSection').classList.add('hidden');
                document.getElementById('fileList').innerHTML = '';
                
                updateUI();
                
                // Fit map back to existing properties
                const layers = existingPropertiesLayer.getLayers();
                if (layers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    layers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        });

        // Import KML functionality
        const kmlFileInput = document.getElementById('kmlFileInput');
        document.getElementById('importKMLBtn').addEventListener('click', () => {
            kmlFileInput.click();
        });

        kmlFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            for (let file of files) {
                if (file.name.endsWith('.kml')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const kmlText = event.target.result;
                        // Determine type based on filename
                        let type = 'available';
                        let name = file.name.replace('.kml', '');
                        
                        if (file.name.toLowerCase().includes('sold')) {
                            type = 'sold';
                        } else if (file.name.toLowerCase().includes('blocked') || file.name.toLowerCase().includes('paused')) {
                            type = 'blocked';
                        } else if (file.name.toLowerCase().includes('partner')) {
                            type = 'partners';
                        }
                        
                        parseKML(kmlText, type, name);
                        
                        // Refit map
                        const layers = existingPropertiesLayer.getLayers();
                        if (layers.length > 0) {
                            const bounds = L.latLngBounds([]);
                            layers.forEach(layer => bounds.extend(layer.getLatLng()));
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    };
                    reader.readAsText(file);
                }
            }
        });
    </script>
</body>
</html>

