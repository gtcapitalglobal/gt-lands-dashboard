<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GT Lands - Property Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(to bottom right, #1a202c, #2d3748) !important;
        }
        body.dark-mode .bg-white {
            background-color: #2d3748 !important;
        }
        body.dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }
        body.dark-mode .text-gray-600 {
            color: #cbd5e0 !important;
        }
        body.dark-mode .text-gray-700 {
            color: #cbd5e0 !important;
        }
        body.dark-mode .text-gray-500 {
            color: #a0aec0 !important;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #374151 !important;
        }
        body.dark-mode .divide-gray-200 > * {
            border-color: #4a5568 !important;
        }
        body.dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }
        body.dark-mode .hover\:bg-blue-50:hover {
            background-color: #2c5282 !important;
        }
        body.dark-mode input {
            background-color: #374151 !important;
            color: #e2e8f0 !important;
        }
        .row-highlight {
            background-color: #fef3c7 !important;
            transition: background-color 0.3s ease;
        }
        body.dark-mode .row-highlight {
            background-color: #78350f !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 flex items-center gap-3">
                        üó∫Ô∏è GT Lands - Property Manager
                    </h1>
                    <p class="text-gray-600 mt-2">Visualize propriedades antigas e compare com novas</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="darkModeToggle" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
                        <span id="darkModeIcon">üåô</span>
                        <span id="darkModeText">Modo Escuro</span>
                    </button>
                    <a href="https://www.gtlands.com" target="_blank" rel="noopener noreferrer">
                        <img src="logo.png" alt="GT Lands" class="h-20 hover:opacity-80 transition-opacity">
                    </a>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üìç Mapa de Propriedades</h2>
                <div class="flex gap-3">
                    <button id="importKMLBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        üì¶ Importar KML ou CSV Antigo
                    </button>
                    <div class="relative">
                        <button id="deleteOldDropdown" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2">
                            üóëÔ∏è Deletar Antigas ‚ñº
                        </button>
                        <div id="deleteOldMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200" style="z-index: 9999;">
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-green-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="available">
                                <span class="w-4 h-4 bg-green-600 rounded-full"></span>
                                <span class="text-gray-700">Deletar Available Lands</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="partners">
                                <span class="w-4 h-4 bg-gray-600 rounded-full"></span>
                                <span class="text-gray-700">Deletar Partners Available</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-red-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="sold">
                                <span class="w-4 h-4 bg-black rounded-full"></span>
                                <span class="text-gray-700">Deletar Sold Lands</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-red-50 transition-colors flex items-center gap-2" data-category="blocked">
                                <span class="w-4 h-4 bg-red-600 rounded-full"></span>
                                <span class="text-gray-700">Deletar Blocked/Paused</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-4 mb-4 text-sm">
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-green-600 rounded-full"></span>
                    <span class="text-gray-700">Available Lands (<span id="availableCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-gray-600 rounded-full"></span>
                    <span class="text-gray-700">Partners Available (<span id="partnersCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-black rounded-full"></span>
                    <span class="text-gray-700">Sold Lands (<span id="soldCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-red-600 rounded-full"></span>
                    <span class="text-gray-700">Blocked/Paused (<span id="blockedCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-yellow-400 rounded-full"></span>
                    <span class="text-gray-700">Novas no Mapa (<span id="newOnMap">0</span>)</span>
                </div>
            </div>

            <div id="map" class="w-full h-96 rounded-lg shadow-md"></div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üì§ Upload de Novas Propriedades (CSV)</h2>
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                <p class="text-gray-600 mb-2">Clique ou arraste arquivos CSV aqui</p>
                <p class="text-sm text-gray-500">Suporta m√∫ltiplos arquivos CSV</p>
            </div>
            <input type="file" id="fileInput" accept=".csv" multiple class="hidden">
            
            <div id="fileList" class="mt-4"></div>
            
            <div class="mt-4 flex gap-4">
                <button id="deleteNewBtn" class="hidden bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    üóëÔ∏è Deletar Todas as Novas
                </button>
                <div class="relative">
                    <button id="deleteFileDropdown" class="hidden bg-orange-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors flex items-center gap-2">
                        üìÅ Deletar por Arquivo ‚ñº
                    </button>
                    <div id="deleteFileMenu" class="hidden absolute left-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-y-auto" style="z-index: 9999;"></div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Estat√≠sticas</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-gray-600 text-sm">Total de Propriedades</p>
                    <p class="text-3xl font-bold text-blue-600" id="totalProperties">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-gray-600 text-sm">Total de Condados</p>
                    <p class="text-3xl font-bold text-green-600" id="totalCounties">0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-gray-600 text-sm">Arquivos Carregados</p>
                    <p class="text-3xl font-bold text-purple-600" id="totalFiles">0</p>
                </div>
            </div>
        </div>

        <!-- Downloads Section -->
        <div id="downloadsSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚¨áÔ∏è Downloads por Condado</h2>
            <div id="downloadButtons" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- Table Section -->
        <div id="tableSection" class="hidden bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üìã Tabela de Propriedades</h2>
                <div class="flex gap-3">
                    <button id="deleteSelectedBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        üóëÔ∏è Deletar Selecionadas
                    </button>
                    <button id="exportSelectedBtn" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        üíæ Exportar Selecionadas
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-4 text-left">
                                <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 cursor-pointer">
                            </th>
                            <th class="px-2 py-2 text-left">Parcel #</th>
                            <th class="px-2 py-2 text-left">Acres</th>
                            <th class="px-2 py-2 text-left">Type</th>
                            <th class="px-2 py-2 text-left">Name</th>
                            <th class="px-2 py-2 text-left">Address</th>
                            <th class="px-2 py-2 text-left">City</th>
                            <th class="px-2 py-2 text-left">County</th>
                            <th class="px-2 py-2 text-left">Amount</th>
                            <th class="px-2 py-2 text-left">Legal Desc</th>
                            <th class="px-2 py-2 text-left">Arquivo</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Hidden file input for KML import -->
        <input type="file" id="kmlFileInput" accept=".kml,.csv" multiple class="hidden">
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([27.32, -81.37], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Layer groups
        const existingPropertiesLayer = L.layerGroup().addTo(map);
        const newPropertiesLayer = L.layerGroup().addTo(map);
        
        // Category-specific layers
        const categoryLayers = {
            available: L.layerGroup().addTo(map),
            partners: L.layerGroup().addTo(map),
            sold: L.layerGroup().addTo(map),
            blocked: L.layerGroup().addTo(map)
        };

        // Data storage
        let allNewProperties = [];
        let loadedFiles = [];
        let countyData = {};
        let fileSourceMap = {}; // NEW: Track which file each property came from

        // Counters
        let propertyCounts = {
            available: 0,
            partners: 0,
            sold: 0,
            blocked: 0,
            new: 0
        };

        // Custom marker icons with house SVG
        const createHouseIcon = (color) => L.divIcon({
            html: `<svg width="30" height="45" viewBox="0 0 30 45">
                <path d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z" fill="${color}" stroke="${color === '#1a1a1a' ? '#000' : color}" stroke-width="1.5"/>
                <g transform="translate(15, 13)">
                    <path d="M-4,-4 L0,-7 L4,-4 Z" fill="#FFF"/>
                    <rect x="-4" y="-4" width="8" height="6" fill="#FFF"/>
                    <rect x="-1.5" y="-1" width="3" height="4" fill="${color}"/>
                    <rect x="-3.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                    <rect x="1.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                </g>
            </svg>`,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const createSoldIcon = () => L.divIcon({
            html: `<svg width="30" height="45" viewBox="0 0 30 45">
                <path d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z" fill="#1a1a1a" stroke="#000" stroke-width="1.5"/>
                <g transform="translate(15, 13)">
                    <path d="M-4,-4 L0,-7 L4,-4 Z" fill="#FFF"/>
                    <rect x="-4" y="-4" width="8" height="6" fill="#FFF"/>
                    <rect x="-1.5" y="-1" width="3" height="4" fill="#1a1a1a"/>
                    <rect x="-3.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                    <rect x="1.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                </g>
                <rect x="7.5" y="4" width="15" height="6" fill="#dc2626" rx="1"/>
                <text x="15" y="8.5" font-family="Arial" font-size="4" font-weight="bold" fill="#FFF" text-anchor="middle">SOLD</text>
            </svg>`,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const createBlockedIcon = () => L.divIcon({
            html: `<svg width="30" height="45" viewBox="0 0 30 45">
                <path d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z" fill="#dc2626" stroke="#b91c1c" stroke-width="1.5"/>
                <circle cx="15" cy="13" r="5" fill="none" stroke="#FFF" stroke-width="1.5"/>
                <line x1="11.5" y1="9.5" x2="18.5" y2="16.5" stroke="#FFF" stroke-width="1.5"/>
            </svg>`,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const icons = {
            available: createHouseIcon('#16a34a'),
            partners: createHouseIcon('#6b7280'),
            sold: createSoldIcon(),
            blocked: createBlockedIcon(),
            new: createHouseIcon('#facc15')
        };

        // Load KML files automatically
        const kmlFiles = [
            { file: 'AvailableLands.kml', type: 'available', name: 'Available Lands' },
            { file: 'PartnersAvailableLands.kml', type: 'partners', name: 'Partners Available' },
            { file: 'SoldLands.kml', type: 'sold', name: 'Sold Lands' },
            { file: 'BlockedPaused.kml', type: 'blocked', name: 'Blocked/Paused' }
        ];

        let kmlLoadedCount = 0;

        function parseKML(kmlText, type, name) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            
            for (let placemark of placemarks) {
                const nameEl = placemark.getElementsByTagName('name')[0];
                
                // Try to get Point coordinates first
                let coordsEl = placemark.getElementsByTagName('coordinates')[0];
                
                if (nameEl && coordsEl) {
                    // Get all coordinates text and split by whitespace and commas
                    const coordsText = coordsEl.textContent.trim();
                    const coordLines = coordsText.split(/\s+/);
                    
                    // Get first coordinate (for polygons, use centroid of first point)
                    const firstCoord = coordLines[0].split(',');
                    const lng = parseFloat(firstCoord[0]);
                    const lat = parseFloat(firstCoord[1]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng], { icon: icons[type] })
                            .bindPopup(`
                                <strong>${nameEl.textContent}</strong><br>
                                ${name}<br><br>
                                <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="inline-block bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-700" style="color: white !important;">
                                    üìç Ver Street View
                                </a>
                            `)
                            .addTo(existingPropertiesLayer)
                            .addTo(categoryLayers[type]);
                        
                        propertyCounts[type]++;
                    }
                }
            }
            
            document.getElementById(`${type}Count`).textContent = propertyCounts[type];
        }

        // Load all KML files
        if (kmlFiles.length > 0) {
            kmlFiles.forEach(({ file, type, name }) => {
                fetch(file)
                    .then(response => response.text())
                    .then(kmlText => {
                        parseKML(kmlText, type, name);
                        kmlLoadedCount++;
                        
                        if (kmlLoadedCount === kmlFiles.length) {
                            const layers = existingPropertiesLayer.getLayers();
                            if (layers.length > 0) {
                                const bounds = L.latLngBounds([]);
                                layers.forEach(layer => bounds.extend(layer.getLatLng()));
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    })
                    .catch(err => {
                        console.error(`Error loading ${file}:`, err);
                        kmlLoadedCount++;
                        
                        if (kmlLoadedCount === kmlFiles.length) {
                            const layers = existingPropertiesLayer.getLayers();
                            if (layers.length > 0) {
                                const bounds = L.latLngBounds([]);
                                layers.forEach(layer => bounds.extend(layer.getLatLng()));
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    });
            });
        }

        // File upload handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            for (let file of files) {
                if (file.name.endsWith('.csv')) {
                    loadedFiles.push(file);
                    processCSV(file);
                }
            }
            updateFileList();
            updateDeleteFileDropdown();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = loadedFiles.map((file, index) => `
                <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3 mb-2">
                    <span class="text-green-700">‚úì ${file.name}</span>
                    <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">‚úï</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            loadedFiles.splice(index, 1);
            updateFileList();
            reprocessAllFiles();
        }

        function reprocessAllFiles() {
            allNewProperties = [];
            countyData = {};
            fileSourceMap = {};
            newPropertiesLayer.clearLayers();
            
            loadedFiles.forEach(file => processCSV(file));
            updateDeleteFileDropdown();
        }

        function processCSV(file) {
            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    const data = results.data.filter(row => row.Coordinates);
                    
                    data.forEach(row => {
                        const coords = row.Coordinates.split(',');
                        const lat = parseFloat(coords[0]);
                        const lng = parseFloat(coords[1]);
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const marker = L.marker([lat, lng], { icon: icons.new })
                                .bindPopup(`
                                    <strong>${row.Name}</strong><br>
                                    ${row.Address}<br>
                                    ${row.City}, ${row.State} ${row.Zip}<br>
                                    <strong>Parcel ID:</strong> ${row['Parcel Number']}<br>
                                    <strong>Acres:</strong> ${row.Acres}<br>
                                    <strong>Amount Due:</strong> $${row['Amount Due']}<br><br>
                                    <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="inline-block bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-700" style="color: white !important;">
                                        üìç Ver Street View
                                    </a>
                                `)
                                .addTo(newPropertiesLayer);
                            
                            // Add click event to marker to highlight table row
                            marker.on('click', function() {
                                const tableSection = document.getElementById('tableSection');
                                const tableBody = document.getElementById('tableBody');
                                const rows = tableBody.getElementsByTagName('tr');
                                
                                // Remove previous highlights
                                for (let r of rows) {
                                    r.classList.remove('row-highlight');
                                }
                                
                                // Find and highlight corresponding row
                                const rowIndex = allNewProperties.findIndex(p => p === row);
                                if (rowIndex >= 0 && rows[rowIndex]) {
                                    rows[rowIndex].classList.add('row-highlight');
                                    
                                    // Scroll to table
                                    tableSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                    
                                    // Remove highlight after 3 seconds
                                    setTimeout(() => {
                                        rows[rowIndex].classList.remove('row-highlight');
                                    }, 3000);
                                }
                            });
                            
                            row.marker = marker;
                            row.sourceFile = file.name; // NEW: Track source file
                            allNewProperties.push(row);
                            
                            // Track file source
                            if (!fileSourceMap[file.name]) {
                                fileSourceMap[file.name] = [];
                            }
                            fileSourceMap[file.name].push(row);
                            
                            const county = row.County;
                            if (!countyData[county]) {
                                countyData[county] = [];
                            }
                            countyData[county].push(row);
                        }
                    });
                    
                    propertyCounts.new = allNewProperties.length;
                    updateUI();
                }
            });
        }

        function updateUI() {
            document.getElementById('newCount').textContent = propertyCounts.new;
            document.getElementById('totalProperties').textContent = propertyCounts.new;
            document.getElementById('totalCounties').textContent = Object.keys(countyData).length;
            document.getElementById('totalFiles').textContent = loadedFiles.length;
            document.getElementById('newOnMap').textContent = propertyCounts.new;
            
            if (allNewProperties.length > 0) {
                document.getElementById('deleteNewBtn').classList.remove('hidden');
                document.getElementById('deleteFileDropdown').classList.remove('hidden');
                document.getElementById('downloadsSection').classList.remove('hidden');
                document.getElementById('tableSection').classList.remove('hidden');
                
                generateDownloadButtons();
                populateTable();
                
                const allLayers = [...existingPropertiesLayer.getLayers(), ...newPropertiesLayer.getLayers()];
                if (allLayers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    allLayers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } else {
                document.getElementById('deleteFileDropdown').classList.add('hidden');
            }
        }

        // NEW: Update delete file dropdown
        function updateDeleteFileDropdown() {
            const menu = document.getElementById('deleteFileMenu');
            menu.innerHTML = '';
            
            Object.keys(fileSourceMap).forEach(fileName => {
                const count = fileSourceMap[fileName].length;
                const button = document.createElement('button');
                button.className = 'w-full text-left px-4 py-3 hover:bg-red-50 transition-colors border-b border-gray-100 flex items-center justify-between';
                button.innerHTML = `
                    <span class="text-gray-700 text-sm">üìÑ ${fileName}</span>
                    <span class="text-gray-500 text-xs">${count} props</span>
                `;
                button.onclick = () => deletePropertiesByFile(fileName);
                menu.appendChild(button);
            });
        }

        // NEW: Delete properties by file
        function deletePropertiesByFile(fileName) {
            if (!confirm(`Deletar todas as ${fileSourceMap[fileName].length} propriedades do arquivo "${fileName}"?`)) {
                return;
            }
            
            // Remove from map
            fileSourceMap[fileName].forEach(property => {
                if (property.marker) {
                    newPropertiesLayer.removeLayer(property.marker);
                }
            });
            
            // Remove from allNewProperties
            allNewProperties = allNewProperties.filter(p => p.sourceFile !== fileName);
            
            // Remove from fileSourceMap
            delete fileSourceMap[fileName];
            
            // Remove from loadedFiles
            const fileIndex = loadedFiles.findIndex(f => f.name === fileName);
            if (fileIndex >= 0) {
                loadedFiles.splice(fileIndex, 1);
            }
            
            // Rebuild county data
            countyData = {};
            allNewProperties.forEach(row => {
                const county = row.County;
                if (!countyData[county]) {
                    countyData[county] = [];
                }
                countyData[county].push(row);
            });
            
            // Update UI
            propertyCounts.new = allNewProperties.length;
            updateFileList();
            updateDeleteFileDropdown();
            updateUI();
            
            // Hide dropdown
            document.getElementById('deleteFileMenu').classList.add('hidden');
            
            // Uncheck select all
            document.getElementById('selectAllCheckbox').checked = false;
        }

        // Toggle delete file dropdown
        document.getElementById('deleteFileDropdown').addEventListener('click', () => {
            const menu = document.getElementById('deleteFileMenu');
            menu.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('deleteFileDropdown');
            const menu = document.getElementById('deleteFileMenu');
            if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function generateDownloadButtons() {
            const container = document.getElementById('downloadButtons');
            container.innerHTML = '';
            
            Object.keys(countyData).forEach(county => {
                const properties = countyData[county];
                const firstProp = properties[0];
                const date = new Date(firstProp['Next Auction']);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const dateStr = `${day}${month}`;
                
                const button = document.createElement('button');
                button.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors';
                button.innerHTML = `‚¨áÔ∏è ${county} - ${properties.length} propriedades`;
                button.onclick = () => downloadCountyCSV(county, dateStr, properties);
                container.appendChild(button);
            });
        }

        function downloadCountyCSV(county, dateStr, properties) {
            const csv = Papa.unparse(properties);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${county}_${dateStr}_coordinates.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function populateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = allNewProperties.map((row, index) => `
                <tr class="hover:bg-blue-50 transition-colors" data-index="${index}">
                    <td class="px-3 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="row-checkbox w-4 h-4 cursor-pointer" data-index="${index}">
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">${row['Parcel Number']}</td>
                    <td class="px-2 py-1 whitespace-nowrap">${row.Acres}</td>
                    <td class="px-2 py-1 whitespace-nowrap">${row['Parcel Type'] || 'N/A'}</td>
                    <td class="px-2 py-1 whitespace-nowrap cursor-pointer">${row.Name}</td>
                    <td class="px-2 py-1 whitespace-nowrap">${row.Address}</td>
                    <td class="px-2 py-1 whitespace-nowrap">${row.City}</td>
                    <td class="px-2 py-1 whitespace-nowrap">${row.County}</td>
                    <td class="px-2 py-1 whitespace-nowrap">$${row['Amount Due']}</td>
                    <td class="px-2 py-1 whitespace-nowrap text-xs">${(row['Legal Description'] || 'N/A').substring(0, 50)}...</td>
                    <td class="px-2 py-1 whitespace-nowrap text-xs text-gray-500">${row.sourceFile}</td>
                </tr>
            `).join('');
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    
                    const index = parseInt(row.getAttribute('data-index'));
                    const property = allNewProperties[index];
                    
                    if (property && property.marker) {
                        map.setView(property.marker.getLatLng(), 16);
                        property.marker.openPopup();
                    }
                });
            });
            
            setupCheckboxListeners();
        }

        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const darkModeText = document.getElementById('darkModeText');
        
        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            darkModeIcon.textContent = '‚òÄÔ∏è';
            darkModeText.textContent = 'Modo Claro';
        }
        
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                darkModeIcon.textContent = '‚òÄÔ∏è';
                darkModeText.textContent = 'Modo Claro';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                darkModeIcon.textContent = 'üåô';
                darkModeText.textContent = 'Modo Escuro';
                localStorage.setItem('darkMode', 'disabled');
            }
        });

        // Delete category dropdown
        document.getElementById('deleteOldDropdown').addEventListener('click', () => {
            document.getElementById('deleteOldMenu').classList.toggle('hidden');
        });

        document.querySelectorAll('.delete-category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.getAttribute('data-category');
                
                if (confirm(`Tem certeza que deseja deletar todas as propriedades da categoria ${category}?`)) {
                    categoryLayers[category].clearLayers();
                    propertyCounts[category] = 0;
                    document.getElementById(`${category}Count`).textContent = '0';
                    document.getElementById('deleteOldMenu').classList.add('hidden');
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('deleteOldDropdown');
            const menu = document.getElementById('deleteOldMenu');
            if (!dropdown.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // Delete all new properties
        document.getElementById('deleteNewBtn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja deletar TODAS as novas propriedades?')) {
                allNewProperties = [];
                loadedFiles = [];
                countyData = {};
                fileSourceMap = {};
                newPropertiesLayer.clearLayers();
                propertyCounts.new = 0;
                
                document.getElementById('deleteNewBtn').classList.add('hidden');
                document.getElementById('deleteFileDropdown').classList.add('hidden');
                document.getElementById('downloadsSection').classList.add('hidden');
                document.getElementById('tableSection').classList.add('hidden');
                document.getElementById('fileList').innerHTML = '';
                
                updateUI();
                
                const layers = existingPropertiesLayer.getLayers();
                if (layers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    layers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        });

        // Import KML functionality
        const kmlFileInput = document.getElementById('kmlFileInput');
        document.getElementById('importKMLBtn').addEventListener('click', () => {
            kmlFileInput.click();
        });

        // Function to parse CSV from Google My Maps
        function parseCSV(csvText, type, name) {
            const lines = csvText.split('\n');
            let count = 0;
            
            for (let i = 1; i < lines.length; i++) { // Skip header
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV line (handle quoted fields)
                const match = line.match(/^"([^"]+)","?([^"]*?)"?,?/);
                if (!match) continue;
                
                const geom = match[1];
                const propName = match[2] || `Property ${i}`;
                
                let lat, lng;
                
                // Extract coordinates from POINT (-81.40599 27.25065)
                const pointMatch = geom.match(/POINT \(([^ ]+) ([^ ]+)\)/);
                if (pointMatch) {
                    lng = parseFloat(pointMatch[1]);
                    lat = parseFloat(pointMatch[2]);
                } else {
                    // Extract from POLYGON ((-81.406225 27.250928, ...))
                    const polygonMatch = geom.match(/POLYGON \(\(([^ ]+) ([^ ]+),/);
                    if (polygonMatch) {
                        lng = parseFloat(polygonMatch[1]);
                        lat = parseFloat(polygonMatch[2]);
                    }
                }
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng], { icon: icons[type] })
                        .bindPopup(`<strong>${propName}</strong><br>${name}`)
                        .addTo(existingPropertiesLayer)
                        .addTo(categoryLayers[type]);
                    
                    count++;
                    propertyCounts[type]++;
                }
            }
            
            document.getElementById(`${type}Count`).textContent = propertyCounts[type];
            console.log(`Imported ${count} properties from CSV`);
        }

        kmlFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileContent = event.target.result;
                    let type = 'available';
                    let name = file.name.replace(/\.(kml|csv)$/, '');
                    
                    // Determine type from filename
                    if (file.name.toLowerCase().includes('sold')) {
                        type = 'sold';
                    } else if (file.name.toLowerCase().includes('blocked') || file.name.toLowerCase().includes('paused')) {
                        type = 'blocked';
                    } else if (file.name.toLowerCase().includes('partner')) {
                        type = 'partners';
                    }
                    
                    // Parse based on file type
                    if (file.name.endsWith('.kml')) {
                        parseKML(fileContent, type, name);
                    } else if (file.name.endsWith('.csv')) {
                        parseCSV(fileContent, type, name);
                    }
                    
                    // Adjust map view
                    const layers = existingPropertiesLayer.getLayers();
                    if (layers.length > 0) {
                        const bounds = L.latLngBounds([]);
                        layers.forEach(layer => bounds.extend(layer.getLatLng()));
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                };
                reader.readAsText(file);
            }
        });

        // Checkbox and selection functionality
        function setupCheckboxListeners() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            // Select all checkbox
            selectAllCheckbox.addEventListener('change', () => {
                rowCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                updateSelectionButtons();
            });
            
            // Individual checkboxes
            rowCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    updateSelectionButtons();
                    // Update select all checkbox
                    const allChecked = Array.from(rowCheckboxes).every(c => c.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
            
            // Delete selected button
            deleteSelectedBtn.addEventListener('click', deleteSelectedProperties);
            
            // Export selected button
            exportSelectedBtn.addEventListener('click', showExportOptions);
        }
        
        function updateSelectionButtons() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            if (checkedCount > 0) {
                deleteSelectedBtn.classList.remove('hidden');
                exportSelectedBtn.classList.remove('hidden');
            } else {
                deleteSelectedBtn.classList.add('hidden');
                exportSelectedBtn.classList.add('hidden');
            }
        }
        
        function deleteSelectedProperties() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowCheckboxes.length === 0) return;
            
            if (!confirm(`Tem certeza que deseja deletar ${rowCheckboxes.length} propriedade(s) selecionada(s)?`)) {
                return;
            }
            
            // Get indices to delete (in reverse order to avoid index shifting)
            const indicesToDelete = Array.from(rowCheckboxes)
                .map(cb => parseInt(cb.getAttribute('data-index')))
                .sort((a, b) => b - a);
            
            // Remove from map
            indicesToDelete.forEach(index => {
                const property = allNewProperties[index];
                if (property && property.marker) {
                    newPropertiesLayer.removeLayer(property.marker);
                }
            });
            
            // Remove from array
            indicesToDelete.forEach(index => {
                allNewProperties.splice(index, 1);
            });
            
            // Rebuild county data and file source map
            countyData = {};
            fileSourceMap = {};
            allNewProperties.forEach(row => {
                const county = row.County;
                if (!countyData[county]) {
                    countyData[county] = [];
                }
                countyData[county].push(row);
                
                if (!fileSourceMap[row.sourceFile]) {
                    fileSourceMap[row.sourceFile] = [];
                }
                fileSourceMap[row.sourceFile].push(row);
            });
            
            // Update UI
            propertyCounts.new = allNewProperties.length;
            updateDeleteFileDropdown();
            updateUI();
            
            // Uncheck select all
            document.getElementById('selectAllCheckbox').checked = false;
        }
        
        function showExportOptions() {
            const format = prompt('Escolha o formato de exporta√ß√£o:\n\n1 - CSV\n2 - KML\n\nDigite 1 ou 2:');
            
            if (format === '1') {
                exportSelectedAsCSV();
            } else if (format === '2') {
                exportSelectedAsKML();
            }
        }
        
        function exportSelectedAsCSV() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const selectedProperties = Array.from(rowCheckboxes).map(cb => {
                const index = parseInt(cb.getAttribute('data-index'));
                return allNewProperties[index];
            });
            
            if (selectedProperties.length === 0) return;
            
            const csv = Papa.unparse(selectedProperties);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `selected_properties_${new Date().getTime()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportSelectedAsKML() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const selectedProperties = Array.from(rowCheckboxes).map(cb => {
                const index = parseInt(cb.getAttribute('data-index'));
                return allNewProperties[index];
            });
            
            if (selectedProperties.length === 0) return;
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Selected Properties</name>
`;
            
            selectedProperties.forEach(prop => {
                const coords = prop.Coordinates.split(',');
                const lat = coords[0];
                const lng = coords[1];
                
                kml += `    <Placemark>
      <name>${prop.Name}</name>
      <description>
        Parcel: ${prop['Parcel Number']}
        Acres: ${prop.Acres}
        Address: ${prop.Address}, ${prop.City}, ${prop.State} ${prop.Zip}
        Amount Due: $${prop['Amount Due']}
      </description>
      <Point>
        <coordinates>${lng},${lat},0</coordinates>
      </Point>
    </Placemark>
`;
            });
            
            kml += `  </Document>
</kml>`;
            
            const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `selected_properties_${new Date().getTime()}.kml`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

